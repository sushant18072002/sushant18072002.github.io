<!DOCTYPE html>
<html>
<head>
    <title>Phase 3 Dynamic Content Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result { background: #f9f9f9; padding: 10px; margin: 5px 0; border-radius: 5px; font-size: 14px; }
        .error { background: #ffebee; color: #c62828; border-left: 4px solid #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; border-left: 4px solid #2e7d32; }
        .warning { background: #fff3e0; color: #f57c00; border-left: 4px solid #f57c00; }
        .info { background: #e3f2fd; color: #1976d2; border-left: 4px solid #1976d2; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; background: #1976d2; color: white; }
        button:hover { background: #1565c0; }
        .form-row { display: flex; gap: 10px; align-items: center; margin: 10px 0; flex-wrap: wrap; }
        h2 { color: #1976d2; border-bottom: 2px solid #1976d2; padding-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Phase 3: Dynamic Content Test</h1>
        <p>Testing dynamic appointment and booking management functionality</p>

        <div class="test-section">
            <h2>ğŸ” Authentication Setup</h2>
            <div class="form-row">
                <input type="email" id="loginEmail" value="customer@travel.com" placeholder="Email">
                <input type="password" id="loginPassword" value="customer123" placeholder="Password">
                <button onclick="testLogin()">Login</button>
                <button onclick="testAdminLogin()">Login as Admin</button>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ“… Create Test Appointment</h2>
            <div class="form-row">
                <input type="text" id="tripId" value="507f1f77bcf86cd799439011" placeholder="Trip ID">
                <input type="date" id="appointmentDate" min="">
                <select id="timeSlot">
                    <option value="">Select Time</option>
                    <option value="09:00 AM - 10:00 AM">09:00 AM - 10:00 AM</option>
                    <option value="02:00 PM - 03:00 PM">02:00 PM - 03:00 PM</option>
                </select>
                <button onclick="createTestAppointment()">Create Appointment</button>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ‘¤ User Dashboard Tests</h2>
            <div class="form-row">
                <button onclick="testUserAppointments()">Test User Appointments</button>
                <button onclick="testUserBookings()">Test User Bookings</button>
                <button onclick="openUserDashboard()">Open User Dashboard</button>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ‘¨ğŸ’¼ Admin Dashboard Tests</h2>
            <div class="form-row">
                <button onclick="testAdminAppointments()">Test Admin Appointments</button>
                <button onclick="testAdminBookings()">Test Admin Bookings</button>
                <button onclick="openAdminDashboard()">Open Admin Dashboard</button>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ”„ Complete Dynamic Flow</h2>
            <div class="form-row">
                <button onclick="testCompleteDynamicFlow()">ğŸš€ Test Complete Dynamic Flow</button>
                <button onclick="clearResults()">ğŸ—‘ï¸ Clear Results</button>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š Test Results</h2>
            <div id="results"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        const FRONTEND_BASE = 'http://localhost:3001';
        let authToken = null;
        let isAdmin = false;
        
        // Set minimum date to tomorrow
        document.getElementById('appointmentDate').min = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        document.getElementById('appointmentDate').value = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML = `<strong>${timestamp}</strong>: ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function apiCall(endpoint, options = {}) {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers,
                    ...options
                });
                
                const data = await response.json();
                return { response, data, success: response.ok };
            } catch (error) {
                return { error: error.message, success: false };
            }
        }
        
        async function testLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            log('ğŸ” Testing customer login...');
            
            const { response, data, success } = await apiCall('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });
            
            if (success && data.success) {
                authToken = data.data.token;
                isAdmin = data.data.user.role === 'admin';
                log(`âœ… Login successful: ${email} (${data.data.user.role})`, 'success');
            } else {
                log(`âŒ Login failed: ${data.message || 'Unknown error'}`, 'error');
            }
        }
        
        async function testAdminLogin() {
            log('ğŸ” Testing admin login...');
            
            const { response, data, success } = await apiCall('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email: 'admin@demo.com', password: 'admin123' })
            });
            
            if (success && data.success) {
                authToken = data.data.token;
                isAdmin = data.data.user.role === 'admin';
                log(`âœ… Admin login successful: ${data.data.user.email}`, 'success');
            } else {
                log(`âŒ Admin login failed: ${data.message || 'Unknown error'}`, 'error');
            }
        }
        
        async function createTestAppointment() {
            if (!authToken) {
                log('âŒ Please login first', 'error');
                return;
            }
            
            const tripId = document.getElementById('tripId').value;
            const date = document.getElementById('appointmentDate').value;
            const timeSlot = document.getElementById('timeSlot').value;
            
            if (!date || !timeSlot) {
                log('âŒ Please select date and time slot', 'error');
                return;
            }
            
            log('ğŸ“… Creating test appointment...');
            
            const appointmentData = {
                tripId,
                customerInfo: {
                    firstName: 'Test',
                    lastName: 'Customer',
                    email: 'test@example.com',
                    phone: '+1234567890'
                },
                bookingDetails: {
                    preferredDate: date,
                    timeSlot: timeSlot,
                    travelers: 2,
                    specialRequests: 'Test appointment for Phase 3'
                },
                tripInfo: {
                    title: 'Dynamic Test Trip',
                    destination: 'Test Destination',
                    price: 1299.99,
                    currency: 'USD'
                }
            };
            
            const { response, data, success } = await apiCall('/appointments', {
                method: 'POST',
                body: JSON.stringify(appointmentData)
            });
            
            if (success && data.success) {
                log(`âœ… Test appointment created: ${data.data.appointment.reference}`, 'success');
                log(`ğŸ“… Scheduled: ${date} at ${timeSlot}`, 'info');
            } else {
                log(`âŒ Appointment creation failed: ${data.message || data.error?.message}`, 'error');
            }
        }
        
        async function testUserAppointments() {
            if (!authToken) {
                log('âŒ Please login first', 'error');
                return;
            }
            
            log('ğŸ‘¤ Testing user appointments endpoint...');
            
            const { response, data, success } = await apiCall('/appointments');
            
            if (success && data.success) {
                const appointments = data.data.appointments || [];
                log(`âœ… User appointments loaded: ${appointments.length} found`, 'success');
                appointments.forEach((apt, index) => {
                    log(`ğŸ“… ${index + 1}. ${apt.appointmentReference} - ${apt.status} - ${apt.trip?.title || 'No title'}`, 'info');
                });
            } else {
                log(`âŒ Failed to load user appointments: ${data.message || data.error?.message}`, 'error');
            }
        }
        
        async function testUserBookings() {
            if (!authToken) {
                log('âŒ Please login first', 'error');
                return;
            }
            
            log('ğŸ‘¤ Testing user bookings endpoint...');
            
            const { response, data, success } = await apiCall('/appointments/bookings');
            
            if (success && data.success) {
                const bookings = data.data.bookings || [];
                log(`âœ… User bookings loaded: ${bookings.length} found`, 'success');
                bookings.forEach((booking, index) => {
                    log(`ğŸ« ${index + 1}. ${booking.bookingReference} - ${booking.status}`, 'info');
                });
            } else {
                log(`âŒ Failed to load user bookings: ${data.message || data.error?.message}`, 'error');
            }
        }
        
        async function testAdminAppointments() {
            if (!authToken || !isAdmin) {
                log('âŒ Please login as admin first', 'error');
                return;
            }
            
            log('ğŸ‘¨ğŸ’¼ Testing admin appointments endpoint...');
            
            const { response, data, success } = await apiCall('/admin/appointments');
            
            if (success && data.success) {
                const appointments = data.data.appointments || [];
                log(`âœ… Admin appointments loaded: ${appointments.length} found`, 'success');
                appointments.forEach((apt, index) => {
                    log(`ğŸ“… ${index + 1}. ${apt.appointmentReference} - ${apt.status} - ${apt.customer?.firstName} ${apt.customer?.lastName}`, 'info');
                });
            } else {
                log(`âŒ Failed to load admin appointments: ${data.message || data.error?.message}`, 'error');
            }
        }
        
        async function testAdminBookings() {
            if (!authToken || !isAdmin) {
                log('âŒ Please login as admin first', 'error');
                return;
            }
            
            log('ğŸ‘¨ğŸ’¼ Testing admin bookings endpoint...');
            
            const { response, data, success } = await apiCall('/admin/bookings');
            
            if (success && data.success) {
                const bookings = data.data.bookings || [];
                log(`âœ… Admin bookings loaded: ${bookings.length} found`, 'success');
                bookings.forEach((booking, index) => {
                    log(`ğŸ« ${index + 1}. ${booking.bookingReference} - ${booking.status} - ${booking.customer?.firstName} ${booking.customer?.lastName}`, 'info');
                });
            } else {
                log(`âŒ Failed to load admin bookings: ${data.message || data.error?.message}`, 'error');
            }
        }
        
        function openUserDashboard() {
            window.open(`${FRONTEND_BASE}/dashboard`, '_blank');
            log('ğŸ”— Opened user dashboard in new tab', 'info');
        }
        
        function openAdminDashboard() {
            window.open(`${FRONTEND_BASE}/admin`, '_blank');
            log('ğŸ”— Opened admin dashboard in new tab', 'info');
        }
        
        async function testCompleteDynamicFlow() {
            log('ğŸš€ Starting complete dynamic flow test...', 'info');
            
            // Step 1: Customer Login
            await testLogin();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Step 2: Create Appointment
            await createTestAppointment();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Step 3: Test User Data
            await testUserAppointments();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testUserBookings();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Step 4: Admin Login
            await testAdminLogin();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Step 5: Test Admin Data
            await testAdminAppointments();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAdminBookings();
            
            log('ğŸ‰ Complete dynamic flow test finished!', 'success');
            log('ğŸ“‹ Next: Open dashboards to see dynamic content', 'info');
        }
        
        // Initialize
        window.onload = () => {
            log('ğŸš€ Phase 3 Dynamic Content Test initialized', 'info');
            log('ğŸ“‹ Testing: Dynamic appointments and bookings display', 'info');
        };
    </script>
</body>
</html>